---
- name: Set ownership of MySQL data directory
  file:
    path: /u101/mysql/data
    owner: mysql
    group: mysql
    recurse: true

- name: Set ownership of MySQL archive directory
  file:
    path: /u102/mysql/archive
    owner: mysql
    group: mysql
    recurse: true

- name: Set ownership of MySQL backup directory
  file:
    path: /u103/mysql/backup
    owner: mysql
    group: mysql
    recurse: true

- name: Set ownership of MySQL log directory
  file:
    path: /u101/mysql/data/log
    owner: mysql
    group: mysql
    recurse: true

- name: Set ownership of archive log bin directory
  file:
    path: /u102/mysql/archive/logbin
    owner: mysql
    group: mysql
    recurse: true

- name: Copy MySQL configuration file
  copy:
    src: my.cnf
    dest: /etc/my.cnf
    owner: root
    group: root
    mode: '0644'

- name: Start MySQL service
  ansible.builtin.service:
    name: mysqld
    state: started
    enabled: true

- name: Extract temporary password from MySQL log
  shell: grep 'temporary password' /u101/mysql/data/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  changed_when: false

- name: Try to connect with new password
  mysql_query:
    login_user: root
    login_password: "{{ mysql_new_password }}"
    query: "SELECT 1"
  register: mysql_new_pwd_test
  failed_when: false
  no_log: true

- name: Reset MySQL root password
  shell: |
    mysql -u root -p'{{ mysql_temp_password.stdout }}' --connect-expired-password -e "
    ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '{{ mysql_new_password }}';
    FLUSH PRIVILEGES;"
  when: 
    - mysql_new_pwd_test.failed
    - mysql_temp_password.stdout != ""
  no_log: true

- name: Flush privileges
  mysql_query:
    login_user: root
    login_password: "{{ mysql_new_password }}"
    query: "FLUSH PRIVILEGES;"
  when: mysql_temp_password.stdout != ""

- name: Test connection with new password
  community.mysql.mysql_query:
    login_user: root
    login_password: "{{ mysql_new_password }}"
    query: "SHOW DATABASES;"
  register: mysql_test_connection
  when: mysql_temp_password.stdout != ""

- name: Confirm password reset success
  debug:
    msg: "MySQL root password successfully reset"
  when: mysql_test_connection is succeeded